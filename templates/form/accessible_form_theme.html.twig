{# Accessible Form Theme - RGAA 4.1 Compliant #}
{# Extends Bootstrap 5 layout with accessibility improvements #}

{% use "bootstrap_5_layout.html.twig" %}

{# Override form_row to add ARIA attributes - RGAA 11.10/11.11 #}
{% block form_row -%}
    {% set row_attr = row_attr|default({})|merge({
        class: (row_attr.class|default('') ~ ' mb-3')|trim
    }) %}

    {# Determine if field is required #}
    {% set is_required = required|default(false) %}

    {# Determine if field has errors #}
    {% set has_errors = not valid and errors|length > 0 %}

    {# Add ARIA attributes to widget #}
    {% set widget_attr = attr|default({}) %}

    {% if is_required %}
        {% set widget_attr = widget_attr|merge({'aria-required': 'true'}) %}
    {% endif %}

    {% if has_errors %}
        {% set widget_attr = widget_attr|merge({
            'aria-invalid': 'true',
            'aria-describedby': id ~ '_error'
        }) %}
    {% endif %}

    {# Render the row #}
    <div{% with {attr: row_attr} %}{{ block('attributes') }}{% endwith %}>
        {{- form_label(form) -}}
        {{- form_widget(form, {'attr': widget_attr}) -}}

        {# Render errors with proper ARIA role #}
        {% if has_errors %}
            <div id="{{ id }}_error" class="invalid-feedback d-block" role="alert" aria-live="polite">
                {{- form_errors(form) -}}
            </div>
        {% endif %}

        {{- form_help(form) -}}
    </div>
{%- endblock form_row %}

{# Override checkbox row for better accessibility #}
{% block checkbox_row -%}
    {% set row_attr = row_attr|default({})|merge({
        class: (row_attr.class|default('') ~ ' mb-3 form-check')|trim
    }) %}

    {% set has_errors = not valid and errors|length > 0 %}
    {% set widget_attr = attr|default({}) %}

    {% if required %}
        {% set widget_attr = widget_attr|merge({'aria-required': 'true'}) %}
    {% endif %}

    {% if has_errors %}
        {% set widget_attr = widget_attr|merge({
            'aria-invalid': 'true',
            'aria-describedby': id ~ '_error'
        }) %}
    {% endif %}

    <div{% with {attr: row_attr} %}{{ block('attributes') }}{% endwith %}>
        {{- form_widget(form, {'attr': widget_attr|merge({'class': 'form-check-input'})}) -}}
        {{- form_label(form, null, {'label_attr': {'class': 'form-check-label'}}) -}}

        {% if has_errors %}
            <div id="{{ id }}_error" class="invalid-feedback d-block" role="alert" aria-live="polite">
                {{- form_errors(form) -}}
            </div>
        {% endif %}

        {{- form_help(form) -}}
    </div>
{%- endblock checkbox_row %}

{# Override form_label to indicate required fields visually and for screen readers #}
{% block form_label -%}
    {% if label is not same as(false) -%}
        {% if required -%}
            {% set label_attr = label_attr|merge({class: (label_attr.class|default('') ~ ' required')|trim}) %}
        {%- endif -%}
        {% if label is empty -%}
            {%- if label_format is not empty -%}
                {% set label = label_format|replace({
                    '%name%': name,
                    '%id%': id,
                }) %}
            {%- else -%}
                {% set label = name|humanize %}
            {%- endif -%}
        {%- endif -%}
        <{{ element|default('label') }}{% if label_attr %}{% with { attr: label_attr } %}{{ block('attributes') }}{% endwith %}{% endif %}>
            {{- translation_domain is same as(false) ? label : label|trans(label_translation_parameters, translation_domain) -}}
            {% if required -%}
                <span class="text-danger" aria-label="obligatoire"> *</span>
            {%- endif %}
        </{{ element|default('label') }}>
    {%- endif -%}
{%- endblock form_label %}

{# Override textarea to add character counter support if maxlength is set #}
{% block textarea_widget -%}
    {% set attr = attr|merge({class: (attr.class|default('') ~ ' form-control')|trim}) %}

    {% if attr.maxlength is defined %}
        {% set attr = attr|merge({
            'aria-describedby': (attr['aria-describedby']|default('') ~ ' ' ~ id ~ '_length')|trim
        }) %}
    {% endif %}

    <textarea {{ block('widget_attributes') }}>{{ value }}</textarea>

    {% if attr.maxlength is defined %}
        <div id="{{ id }}_length" class="form-text" aria-live="polite">
            Maximum {{ attr.maxlength }} caract√®res
        </div>
    {% endif %}
{%- endblock textarea_widget %}
